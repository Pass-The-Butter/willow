version: '3.8'

services:
  # MCP server connecting Claude â†’ AuraDB
  neo4j-mcp:
    build:
      context: ./infrastructure/neo4j
      dockerfile: Dockerfile
    container_name: willow-neo4j-mcp
    ports:
      - "3001:3001"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - MCP_PORT=${MCP_PORT}
    networks:
      - willow-network
    volumes:
      - ./core/skills:/skills:ro
      - ./domains:/domains:ro

  # Skill execution API
  willow-api:
    build:
      context: ./core/api
      dockerfile: Dockerfile
    container_name: willow-api
    ports:
      - "8000:8000"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    extra_hosts:
      - "bunny:100.105.129.101" # Tailscale IP for Xeon Server
    networks:
      - willow-network
    volumes:
      - ./core/skills:/app/skills:ro
      - ./domains:/app/domains:ro

  # N8N workflow orchestration
  n8n:
    image: n8nio/n8n:latest
    container_name: willow-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - willow-network

  # MSSQL reader (placeholder - will configure when credentials provided)
  # mssql-reader:
  #   image: mcr.microsoft.com/mssql-tools
  #   container_name: willow-mssql-reader
  #   networks:
  #     - willow-network

  # Population Database (Postgres)
  population-db:
    image: postgres:15-alpine
    container_name: willow-population-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - population_data:/var/lib/postgresql/data
    networks:
      - willow-network

volumes:
  n8n_data:
  population_data:

networks:
  willow-network:
    driver: bridge
